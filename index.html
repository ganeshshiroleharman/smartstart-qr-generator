<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Z-Wave SmartStart QR Generator</title>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>

body {
    font-family: Arial;
    background: #f4f4f4;
    padding: 20px;
}

.container {
    background: white;
    padding: 20px;
    max-width: 500px;
    border-radius: 8px;
}

input {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 15px;
}

button {
    padding: 10px;
    margin-right: 10px;
}

.error {
    color: red;
}

.success {
    color: green;
}

canvas {
    margin-top: 20px;
}

.footer {
    margin-top: 20px;
    font-size: 12px;
    color: #666;
}

</style>

</head>
<body>

<div class="container">

<h2>Z-Wave SmartStart QR Generator</h2>

<label>Device Specific Key (DSK)</label>

<input id="dsk"
       placeholder="12345-67890-12345-67890-12345-67890-12345-67890"
       oninput="formatDSK(this)">

<div id="dskError" class="error"></div>

<button onclick="generateQR()">Generate QR</button>

<button onclick="downloadQR()">Download QR</button>

<div id="status"></div>

<canvas id="qrCanvas"></canvas>

<div class="footer">
Version: v1.0
</div>

</div>

<script>

const APP_VERSION = "v1.0";

console.log("SmartStart QR Generator Version:", APP_VERSION);

let currentQRText = "";


// =========================
// Auto format DSK
// =========================

function formatDSK(input)
{
    let value = input.value.replace(/\D/g, "");

    value = value.substring(0, 40);

    let groups = value.match(/.{1,5}/g);

    input.value = groups ? groups.join("-") : value;
}


// =========================
// Validate DSK
// =========================

function validateDSK(dsk)
{
    const regex = /^(\d{5}-){7}\d{5}$/;

    if (!regex.test(dsk))
        return "Invalid DSK format";

    const parts = dsk.split("-");

    for (let part of parts)
    {
        const num = parseInt(part);

        if (num < 0 || num > 65535)
            return "Each group must be 00000â€“65535";
    }

    return null;
}


// =========================
// Build correct QR string
// =========================

function buildQRString(dsk)
{
    return "ZWS2DSK:" + dsk;
}


// =========================
// Generate QR
// =========================

function generateQR()
{
    clearErrors();

    const dsk = document.getElementById("dsk").value.trim();

    const error = validateDSK(dsk);

    if (error)
    {
        document.getElementById("dskError").innerText = error;

        document.getElementById("status").innerHTML =
            "<span class='error'>Fix errors first</span>";

        return;
    }

    currentQRText = buildQRString(dsk);

    QRCode.toCanvas(
        document.getElementById("qrCanvas"),
        currentQRText,
        { width: 300 }
    );

    document.getElementById("status").innerHTML =
        "<span class='success'>QR generated successfully</span>";

    console.log("Generated QR Text:", currentQRText);
    console.log("App Version:", APP_VERSION);
}


// =========================
// Download QR
// =========================

function downloadQR()
{
    if (!currentQRText)
    {
        alert("Generate QR first");
        return;
    }

    const canvas = document.getElementById("qrCanvas");

    const link = document.createElement("a");

    link.download = "zwave-smartstart-qr.png";

    link.href = canvas.toDataURL();

    link.click();
}


// =========================
// Clear errors
// =========================

function clearErrors()
{
    document.getElementById("dskError").innerText = "";
}

</script>

</body>
</html>
