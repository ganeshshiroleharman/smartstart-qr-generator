<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Z-Wave SmartStart QR Generator</title>

    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

    <style>
        body {
            font-family: Arial;
            padding: 20px;
            background: #f4f4f4;
        }

        .container {
            background: white;
            padding: 20px;
            width: 500px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }

        #qrCanvas {
            margin-top: 20px;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }
    </style>

</head>

<body>

    <div class="container">

        <h2>Z-Wave SmartStart QR Generator</h2>

        <label>DSK (xxxxx-xxxxx-xxxxx-xxxxx-xxxxx-xxxxx-xxxxx-xxxxx)</label>
        <input id="dsk" oninput="formatDSK(this)">
        <div id="dskError" class="error"></div>

        <label>Manufacturer ID (4 hex digits)</label>
        <input id="manufacturerId" value="045A">
        <div id="manufacturerError" class="error"></div>

        <label>Product Type (4 hex digits)</label>
        <input id="productType" value="0004">
        <div id="productTypeError" class="error"></div>

        <label>Product ID (4 hex digits)</label>
        <input id="productId" value="0362">
        <div id="productIdError" class="error"></div>

        <button onclick="generateQR()">Generate QR</button>
        <button onclick="downloadQR()">Download QR</button>

        <div id="status"></div>

        <canvas id="qrCanvas"></canvas>

    </div>

    <script>

        let currentPayload = "";


        // ==========================
        // Format DSK automatically
        // ==========================

        function formatDSK(input) {

            let value = input.value.replace(/\D/g, "");

            value = value.substring(0, 40);

            let groups = value.match(/.{1,5}/g);

            input.value = groups ? groups.join("-") : value;
        }


        // ==========================
        // Validate DSK
        // ==========================

        function validateDSK(dsk) {

            const regex = /^(\d{5}-){7}\d{5}$/;

            if (!regex.test(dsk)) {
                return "DSK must be exactly 8 groups of 5 digits";
            }

            const parts = dsk.split("-");

            for (let part of parts) {

                const num = parseInt(part);

                if (num < 0 || num > 65535) {
                    return "Each DSK group must be between 00000 and 65535";
                }
            }

            return null;
        }


        // ==========================
        // Validate hex field
        // ==========================

        function validateHex(value, fieldName) {

            if (!/^[0-9A-Fa-f]{4}$/.test(value)) {
                return fieldName + " must be exactly 4 hex digits";
            }

            return null;
        }


        // ==========================
        // Build SmartStart payload
        // ==========================

        function buildSmartStartPayload(dsk, manufacturerId, productType, productId) {

            const prefix = "90";
            const version = "01";
            const keyFlags = "32";

            return prefix +
                version +
                keyFlags +
                dsk +
                manufacturerId.toUpperCase() +
                productType.toUpperCase() +
                productId.toUpperCase();
        }


        // ==========================
        // Generate QR
        // ==========================

        function generateQR() {

            clearErrors();

            const dskInput = document.getElementById("dsk").value.trim();

            const manufacturerId = document.getElementById("manufacturerId").value.trim();

            const productType = document.getElementById("productType").value.trim();

            const productId = document.getElementById("productId").value.trim();

            let hasError = false;


            const dskError = validateDSK(dskInput);

            if (dskError) {

                document.getElementById("dskError").innerText = dskError;

                hasError = true;
            }


            const manufacturerError = validateHex(manufacturerId, "Manufacturer ID");

            if (manufacturerError) {

                document.getElementById("manufacturerError").innerText = manufacturerError;

                hasError = true;
            }


            const productTypeError = validateHex(productType, "Product Type");

            if (productTypeError) {

                document.getElementById("productTypeError").innerText = productTypeError;

                hasError = true;
            }


            const productIdError = validateHex(productId, "Product ID");

            if (productIdError) {

                document.getElementById("productIdError").innerText = productIdError;

                hasError = true;
            }


            if (hasError) {

                document.getElementById("status").innerHTML =
                    "<span class='error'>Fix errors before generating QR</span>";

                return;
            }


            const dsk = dskInput.replace(/-/g, "");

            currentPayload = buildSmartStartPayload(
                dsk,
                manufacturerId,
                productType,
                productId
            );


            QRCode.toCanvas(document.getElementById("qrCanvas"), currentPayload, {
                width: 300
            });


            document.getElementById("status").innerHTML =
                "<span class='success'>QR generated successfully</span>";

        }


        // ==========================
        // Download QR
        // ==========================

        function downloadQR() {

            if (!currentPayload) {

                alert("Generate QR first");

                return;
            }

            const canvas = document.getElementById("qrCanvas");

            const link = document.createElement("a");

            link.download = "smartstart_qr.png";

            link.href = canvas.toDataURL();

            link.click();
        }


        // ==========================
        // Clear errors
        // ==========================

        function clearErrors() {

            document.getElementById("dskError").innerText = "";

            document.getElementById("manufacturerError").innerText = "";

            document.getElementById("productTypeError").innerText = "";

            document.getElementById("productIdError").innerText = "";

        }

    </script>

</body>

</html>
